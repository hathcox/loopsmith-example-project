# Story 1.3: Player Setup — Cube with WASD Physics Movement

Status: done

## Story

As a player,
I want to move a cube across the ground plane using WASD keys,
So that I can navigate the play area.

## Acceptance Criteria

1. A `PlayerSetup.cs` setup class in `Assets/Scripts/Setup/` programmatically creates the player cube in the GameScene
2. The player cube has a Rigidbody (non-kinematic, gravity enabled) and BoxCollider (non-trigger) configured via setup code
3. The player cube has a PlayerController MonoBehaviour attached via setup code
4. A PlayerMaterial (URP Lit) is generated into `Assets/Generated/Materials/` and applied to the cube
5. The player cube is tagged "Player" via setup code
6. When the player presses W, A, S, or D keys, the player cube moves in the corresponding direction using Rigidbody physics (not Transform translation)
7. Movement is applied via AddForce or velocity in FixedUpdate
8. The PlayerController reads input via Legacy Input Manager (`Input.GetAxis`)

## Tasks / Subtasks

- [x] Task 1: Create PlayerController MonoBehaviour (AC: #6, #7, #8)
  - [x] Create `Assets/Scripts/PlayerController.cs`
  - [x] Read horizontal input via `Input.GetAxis("Horizontal")` and vertical via `Input.GetAxis("Vertical")`
  - [x] Apply movement force to Rigidbody in `FixedUpdate` using `AddForce` or direct velocity setting
  - [x] Define movement speed as a private constant (e.g., `private const float MoveSpeed = 10f;`)
  - [x] Cache Rigidbody reference in `Awake()` using `GetComponent<Rigidbody>()`
  - [x] Constrain Rigidbody rotation to prevent cube from tipping (freeze X and Z rotation)
- [x] Task 2: Create PlayerSetup class (AC: #1, #2, #3, #4, #5)
  - [x] Create `Assets/Scripts/Setup/PlayerSetup.cs` implementing `IGameSetup`
  - [x] Set `ExecutionOrder` after SceneSetup (e.g., order 200)
  - [x] Create player cube via `GameObject.CreatePrimitive(PrimitiveType.Cube)`
  - [x] Add and configure Rigidbody: non-kinematic, gravity enabled, freeze X/Z rotation
  - [x] Ensure BoxCollider is non-trigger (default)
  - [x] Attach PlayerController component via `AddComponent<PlayerController>()`
  - [x] Generate PlayerMaterial (URP Lit) into `Assets/Generated/Materials/`
  - [x] Apply PlayerMaterial to cube's MeshRenderer
  - [x] Set tag to "Player"
  - [x] Position cube on top of ground plane at center

## Dev Notes

### Architecture Compliance

- **Thin MonoBehaviour Pattern:** PlayerController is a thin wrapper — reads input and applies physics. No game logic (score, win) in this class.
- **Setup-Oriented:** All GameObject creation, component attachment, and configuration done in PlayerSetup.cs. No Inspector configuration.
- **Naming:** `PlayerController.cs` in `Assets/Scripts/`, `PlayerSetup.cs` in `Assets/Scripts/Setup/`
- **Private fields:** Use underscore prefix: `_rigidbody`, `_moveDirection`
- **Events:** PlayerController does NOT use events — it's input→physics only

### Technical Requirements

- **Input:** Legacy Input Manager only. `Input.GetAxis("Horizontal")` maps to A/D keys. `Input.GetAxis("Vertical")` maps to W/S keys.
- **Physics:** Use `Rigidbody.AddForce(movement * MoveSpeed)` or `Rigidbody.velocity = new Vector3(h * MoveSpeed, rb.velocity.y, v * MoveSpeed)`
- **FixedUpdate:** All physics operations MUST be in `FixedUpdate`, not `Update`
- **Rotation Freeze:** Set `Rigidbody.constraints = RigidbodyConstraints.FreezeRotationX | RigidbodyConstraints.FreezeRotationZ` to prevent tipping
- **Player position:** Start at `(0, 0.5f, 0)` — half unit above ground plane origin so cube sits on surface
- **WASD Mapping:** W=forward (+Z), S=back (-Z), A=left (-X), D=right (+X) in top-down view. Verify camera orientation alignment.

### File Structure Requirements

```
Assets/
├── Scripts/
│   ├── PlayerController.cs        # NEW - MonoBehaviour, input + physics
│   └── Setup/
│       └── PlayerSetup.cs         # NEW - creates player cube
├── Generated/
│   └── Materials/
│       └── PlayerMaterial.mat     # NEW - generated by PlayerSetup
```

### Testing Requirements

- PlayerController is a thin MonoBehaviour — no pure C# logic to unit test in this story
- Verification: WASD moves the cube smoothly across the ground plane in Play mode

### Anti-Patterns to Avoid

- Do NOT use `Transform.Translate()` — must use Rigidbody physics
- Do NOT use `FindObjectOfType` or `GameObject.Find` at runtime
- Do NOT put any game logic (score, collection) in PlayerController
- Do NOT use `Update()` for physics — use `FixedUpdate()`

### Dependencies

- **Requires Story 1.1:** IGameSetup interface, SetupRunner
- **Requires Story 1.2:** SceneSetup with ground plane and camera

### References

- [Source: _bmad-output/planning-artifacts/architecture.md#Testability Pattern]
- [Source: _bmad-output/planning-artifacts/architecture.md#Physics Configuration]
- [Source: _bmad-output/planning-artifacts/architecture.md#Component Architecture]
- [Source: _bmad-output/planning-artifacts/epics.md#Story 1.3]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- Unity batch mode compilation: SUCCESS (no errors, no warnings)

### Completion Notes List

- **Task 1 — PlayerController:** Created thin MonoBehaviour at `Assets/Scripts/PlayerController.cs`. Reads horizontal/vertical input via `Input.GetAxis` in `FixedUpdate`, applies movement using `Rigidbody.velocity` for responsive control. Movement speed defined as `private const float MoveSpeed = 10f`. Rigidbody reference cached in `Awake()` with null-check guard. Diagonal movement normalized. Rotation constraints (freeze X/Z) are set in PlayerSetup.
- **Task 2 — PlayerSetup:** Created `Assets/Scripts/Setup/PlayerSetup.cs` implementing `IGameSetup` with `ExecutionOrder = 200` (after SceneSetup at 100). Creates player cube via `CreatePrimitive`, configures Rigidbody (non-kinematic, gravity, freeze X/Z rotation), ensures BoxCollider non-trigger, attaches PlayerController, generates URP Lit PlayerMaterial (blue color) saved to `Assets/Generated/Materials/`, applies material, tags "Player", positions at (0, 0.5, 0).
- **Testing:** Story Dev Notes specify no pure C# unit tests for this thin MonoBehaviour. Verification is via Unity compilation (passed) and Play mode WASD movement testing.

### File List

- `Assets/Scripts/PlayerController.cs` — NEW
- `Assets/Scripts/Setup/PlayerSetup.cs` — NEW
- `Assets/Generated/Materials/PlayerMaterial.mat` — NEW (generated at editor time by PlayerSetup via F5 Rebuild)

## Senior Developer Review (AI)

**Reviewer:** Iggy (AI-assisted) on 2026-02-15
**Issues Found:** 3 High, 4 Medium, 1 Low
**Issues Fixed:** 6 (all HIGH and MEDIUM)

### Fixed Issues

1. **[HIGH] H1 — PlayerSetup missing directory safety check:** Added `EnsureMaterialDirectory()` to create `Assets/Generated/Materials/` if it doesn't exist before `AssetDatabase.CreateAsset`.
2. **[HIGH] H2 — PlayerController null-check on Rigidbody:** Added null-check in `Awake()` with `Debug.LogError` and `enabled = false` guard.
3. **[HIGH] H3 — AddForce causes sluggish movement:** Changed from `AddForce(movement * MoveSpeed)` to `Rigidbody.velocity` for direct, responsive control. Matches Dev Notes alternative pattern.
4. **[MEDIUM] M1 — PlayerSetup doesn't save scene:** Added `EditorSceneManager.SaveOpenScenes()` after creating player cube.
5. **[MEDIUM] M2 — Shader fallback uses wrong color property:** Added `isUrp` flag to use `_BaseColor` for URP Lit and `_Color` for Standard shader.
6. **[MEDIUM] M3 — Story File List incorrect claim:** Changed "generated at runtime" to "generated at editor time" in File List.
7. **[MEDIUM] M4 — Diagonal movement not normalized:** Added `sqrMagnitude > 1f` check with `Normalize()` to prevent 41% speed boost on diagonals.

### Remaining Issues (LOW — no action required)

1. **[LOW] L1 — `static readonly` for Color:** Reviewed and confirmed correct — C# `Color` struct cannot be `const`.

## Change Log

- 2026-02-15: Implemented Story 1.3 — Created PlayerController MonoBehaviour with WASD physics movement and PlayerSetup class for programmatic player cube creation
- 2026-02-15: Code review fixes — null-check Rigidbody, normalize diagonal movement, switch to velocity-based movement, add directory safety check, fix shader fallback color property, save scene after setup
